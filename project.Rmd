---
title: "project"
author: "Noah Hansen, Yuhan Dai, Steven Hizmi"
date: "4/19/2021"
output: html_document
---

```{r setup, include=T, message=F}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```

```{r include=F}
# used to combine separate csvs into one

# library(plyr)
# from https://statisticsglobe.com/merge-csv-files-in-r

# data_all <- list.files(path = "D:/stat340/data",     # Identify all csv files in folder
#                        pattern = "*.csv", full.names = TRUE) %>% 
#   lapply(read_csv) %>%                              # Store all files in list
#   bind_rows                                         # Combine data sets into one data set 

# write.csv(data_all, file = "D:/stat340/data/aqi_1980_2019", sep=",")
```


```{r}
aqi_dat = read_csv("aqi_1980_2019.csv")
aqi_dat = aqi_dat %>% select(-X1, 
                     cbsa = CBSA,
                     date = Date,
                     aqi = AQI,
                     category = Category,
                     cbsa_code = `CBSA Code`, 
                     param = `Defining Parameter`, 
                     site = `Defining Site`,
                     num_sites = `Number of Sites Reporting`)

aqi_dat = aqi_dat %>% mutate(year = year(date), month = month(date), wday = wday(date, label=TRUE))
head(aqi_dat)
```

This doesn't mean anything, really, as it combines all pollutants (maybe that is okay though?). Param is really 'Defining Parameter', which means it is the param chosen for the day from multiple that were measured. My guess is that they chose the pollutant with the worst AQI. If one pollutant is bad, then it probably doesn't matter too much if other pollutants are not as bad. Either way it is unhealthy for senitive groups or everyone. However, having two pollutants at moderate has to be worse than just one.

```{r}
temp = aqi_dat %>% group_by(year) %>% summarize(avg_aqi = mean(aqi))
temp %>% arrange(avg_aqi)
```

TODO: The parameter is different depending on the date. If a CBSA reports multiple pollutants in a day, only one is chosen in the dataset. Is this okay? 


>_The following section groups the data by year and pollution type, then summarized the data by taking the mean of the AQI. 
The graph depicts the change of air quality data over the last 40 years. The horizontal line indicates the Good Level for AQI, below the line (50) means the air quality is satisfactory.
The details regarding the levels of concern for AQI can be found here: https://www.airnow.gov/aqi/aqi-basics/_

```{r, message=F}
yr_pol = aqi_dat %>% group_by(year, param) %>% summarise(avg_aqi = mean(aqi))

ggplot(yr_pol, aes(x = year, y = avg_aqi, color = param)) +
  geom_line(size = 1) +
  geom_hline(yintercept = 50) +
  labs(title = "US Air Quality Data by Pollution Type")
```

As shown above, US pollution overall is improving since the AQI is decreasing for most of the pollution type. However, there are drastic increases for both CO and PM2.5. TODO: Further analysis on these two pollutants. (source of these two pollutants, vehicle or industrial. maybe check for rural vs urban)

```{r}
aqi_dat %>% filter(date > "2018-02-07" & date < "2019-02-07", cbsa_code == 11020)
```

This table shows the average and maximum gaps in reporting each criteria pollutant for each CBSA. Maybe we would want to exclude some of the pollutants that are not measured very often per CBSA code. We can repeat this analysis for different time periods instead of the whole 40 years, as some stop reporting certain values for years at a time.

```{r}
time_diff <- aqi_dat %>% 
  group_by(cbsa_code,param) %>% 
  arrange(date) %>% 
  # lag() gets the value from the previous row. 
  # Then extract digits from output of the difference, which is a sentence for some reason
  summarise(date_diff = as.integer(str_extract(date-lag(date),"\\d*"))) %>% 
  summarise(diff_avg = mean(date_diff, na.rm = T), diff_max = max(date_diff, na.rm=T))

time_diff
```
Displays the average difference in days for reporting each pollutant in a nicer format. Also shows what pollutants each CBSA reports 
```{r}
time_diff %>% select(-diff_max) %>% pivot_wider(names_from = param, values_from = diff_avg)
```
For analysis on all 40 years, we probably want at least 5 datapoints a year for a total sample of 200. The avg difference for this would be less than 73. Maybe not the best metric because one CBSA meets this standard but did not report for 37 years. If a CBSA has data for a pollutant daily, long periods do not bring the average down very much.

```{r}
time_diff %>% filter(diff_avg < 73)
```

```{r include = F}
# Don't know why this way doesn't end up working for date difference

# how to take the differce in dates
# x1 <- as.Date("2019-02-07")
# x2 <- as.Date("2018-02-07")
# x1 +1
# abs(julian(x1,x2)[1])
# 
# julian_new = function(date, origin){
#   return(tryCatch(expr = julian(date,origin), error = function(e){print(e); return(NA)}))
# }

# aqi_dat %>% mutate(date_diff = abs(julian_new(date,lag(date))[1])) 
```


```{r}
county_2015 <- read.csv("annual_aqi_by_county_2015.csv")
county_2016 <- read.csv("annual_aqi_by_county_2016.csv")
county_2017 <- read.csv("annual_aqi_by_county_2017.csv")
county_2018 <- read.csv("annual_aqi_by_county_2018.csv")
county_2019 <- read.csv("annual_aqi_by_county_2019.csv")
county_2020 <- read.csv("annual_aqi_by_county_2020.csv")

daily_2019 <- read.csv("daily_44201_2019.csv")
daily_2020 <- read.csv("daily_44201_2020.csv")

counties <- rbind(county_2015,county_2016, county_2017, county_2018, county_2019, county_2020) 

```

**With the lockdowns during the Covid pandemic, it gave us an opportunity to see what happened to air pollution with less human activity in three Wisconsin counties: Dane, Milwaukee, and Waukesha counties. So we have collected county data over the last 6 years to compare with data during the lockdowns. We also collected daily data from 2020, from January to June (as that is the most updated data out there thus far).**
```{r, warning=FALSE}
wisconsin_counties <- counties %>% filter(County == "Dane" | County == "Milwaukee" | County == "Waukesha")
ggplot(wisconsin_counties, aes(Year, Days.Ozone, color = County)) +
  geom_smooth() +
  ylab("Ozone Action Days") +
  ggtitle("Ozone levels in WI over last 6 years")
  
```
**According to the U.S. Air Quality Index (AQI), Ozone levels at or below 50 represents good air quality whereas Ozone levels at or above 300 represents hazardous air quality. Ozone Action Days are days that are declared to be of caution to citizens, as they should limit their time outdoors. As we can see, ozone action days from 2015 to 2019 stay around 125, with Milwaukee county being higher on average. But in 2020, we see a significant trend downwards. In March of 2020, the Governor of Wisconsin issued a stay at home order, and the closure of all non essential business due to the Covid outbreak. We can clearly see that the decrease in human activity led to less days of harmful Ozone levels in these three Wisconsin counties. To confirm this conclusion, we are going to look at the daily data of these three counties in the first half of 2020 and see if these changes coincide with the stay at home orders. **

```{r}
require(lubridate)
wisconsin_daily <- daily_2020 %>% filter(County.Name == "Dane" | County.Name == "Milwaukee" | County.Name == "Waukesha" ) %>% mutate(Date.Local = month(Date.Local))


ggplot(wisconsin_daily, aes(Date.Local, AQI, color= County.Name)) +
  geom_point() +
  xlab("Month") +
  ggtitle("Ozone levels first 6 months of 2020")

```
**Considering that the first lockdown in Wisconsin was March, the ozone levels don't go beyond 50, which is deemed safe. The ozone levels don't start increasing until May and June, which is to be expected as Ozone levels increase during summer. The question is: Did Covid have an affect on the Ozone levels or was it increased due to it being Summer? To see which is true, we decided to look at the daily data from 2019, with no stay at home orders to see how they compare.**

```{r}
wisconsin_daily_19 <- daily_2019 %>% filter(County.Name == "Dane" | County.Name == "Milwaukee" | County.Name == "Waukesha" ) %>% mutate(Date.Local = month(Date.Local))


ggplot(wisconsin_daily_19, aes(Date.Local, AQI, color = County.Name)) +
  geom_point() +
  xlab("Month") +
  ggtitle("Ozone levels daily in 2019")
```
**Looking at this graph, the Ozone levels are above 50 by mid-February. Compared to 2020, the 2019 Ozone levels increased far more quickly than in 2020. The first case of Covid was reported in February in Wisconsin. So it is possible many people began to stay at home before the stay at home order, which could be an explanation in the disparity between the early months of February in 2019 and 2020. We think without a doubt that Covid had an impact in these Wisconsin counties, especially Milwaukee as it is more industrious than Waukesha and Madison. With data, we have seen the impact that human activity has on air pollution. It can already be seen that stopping human activity for a few months made the Ozone levels stay under 50 far longer than with regular human activity. We suggest that this is enough evidence that we can really make a change for the better, and that lowering pollution levels should remain a priority.**


